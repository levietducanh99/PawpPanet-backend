# Media Sign API - Cloudinary Upload Documentation

## Overview

The Media Sign API provides secure, signed upload signatures for Cloudinary uploads. This API enforces strict folder structures and naming conventions based on upload context, preventing the frontend from arbitrarily placing files in unauthorized locations.

## ‚ö†Ô∏è Important Rules

1. **This API ONLY generates signatures** - it does NOT upload files or save to database
2. **No dependencies on Pet/Post/User services** - it's completely standalone
3. **Frontend CANNOT override folder/naming rules** - all decisions are made server-side
4. **Signed uploads are required** - prevents unauthorized uploads

## üîó Endpoint

```
POST /api/v1/media/sign
```

## üìã Request Format

```json
{
  "context": "USER_AVATAR",
  "ownerId": 123,
  "slug": "golden-retriever",
  "resourceType": "image"
}
```

### Request Fields

| Field | Type | Required | Description |
|-------|------|----------|-------------|
| `context` | enum | ‚úÖ Yes | Upload context - determines folder and validation rules |
| `ownerId` | Long | Conditional | Required for USER/PET/POST contexts |
| `slug` | String | Conditional | Required for ENCYCLOPEDIA contexts (must be lowercase kebab-case) |
| `resourceType` | String | ‚ùå No | Resource type (default: "image"). Valid: image, video, raw, auto |

### Valid Context Values

| Context | Required Field | Folder Structure | Public ID |
|---------|---------------|------------------|-----------|
| `USER_AVATAR` | `ownerId` | `pawplanet/users/{ownerId}/avatar` | `avatar` (fixed) |
| `PET_AVATAR` | `ownerId` | `pawplanet/pets/{ownerId}/avatar` | `avatar` (fixed) |
| `PET_GALLERY` | `ownerId` | `pawplanet/pets/{ownerId}/gallery` | Auto-generated |
| `POST_MEDIA` | `ownerId` | `pawplanet/posts/{ownerId}` | Auto-generated |
| `ENCYCLOPEDIA_CLASS` | `slug` | `pawplanet/encyclopedia/classes/{slug}` | `{slug}` |
| `ENCYCLOPEDIA_SPECIES` | `slug` | `pawplanet/encyclopedia/species/{slug}` | `{slug}` |
| `ENCYCLOPEDIA_BREED` | `slug` | `pawplanet/encyclopedia/breeds/{slug}` | `{slug}` |

## üì§ Response Format

```json
{
  "signature": "a1b2c3d4e5f6...",
  "timestamp": 1704196800,
  "api_key": "123456789012345",
  "cloud_name": "your-cloud-name",
  "asset_folder": "pawplanet/users/123/avatar",
  "public_id": "avatar",
  "resource_type": "image"
}
```

### Response Fields

| Field | Type | Description |
|-------|------|-------------|
| `signature` | String | Cryptographic signature for upload verification |
| `timestamp` | Long | Unix timestamp (seconds) |
| `api_key` | String | Cloudinary API key (safe to expose) |
| `cloud_name` | String | Cloudinary cloud name |
| `asset_folder` | String | Exact folder path - frontend MUST use this |
| `public_id` | String | Pre-determined public ID (null if auto-generated) |
| `resource_type` | String | Resource type for upload |

## üî• Usage Examples

### Example 1: Upload User Avatar

**Request:**
```json
POST /api/v1/media/sign
{
  "context": "USER_AVATAR",
  "ownerId": 42
}
```

**Response:**
```json
{
  "signature": "abc123...",
  "timestamp": 1704196800,
  "api_key": "123456789012345",
  "cloud_name": "pawplanet",
  "asset_folder": "pawplanet/users/42/avatar",
  "public_id": "avatar",
  "resource_type": "image"
}
```

**Result:**
- Folder: `pawplanet/users/42/avatar/`
- Public ID: `avatar`
- Full URL: `https://res.cloudinary.com/pawplanet/image/upload/v1/pawplanet/users/42/avatar/avatar.jpg`

### Example 2: Upload to Pet Gallery

**Request:**
```json
POST /api/v1/media/sign
{
  "context": "PET_GALLERY",
  "ownerId": 789
}
```

**Note:** For PET contexts, `ownerId` is interpreted as `petId`. Backend will verify the authenticated user owns pet 789.

**Response:**
```json
{
  "signature": "xyz789...",
  "timestamp": 1704196800,
  "api_key": "123456789012345",
  "cloud_name": "pawplanet",
  "asset_folder": "pawplanet/pets/789/gallery",
  "public_id": null,
  "resource_type": "image"
}
```

**Result:**
- Folder: `pawplanet/pets/789/gallery/`
- Public ID: Auto-generated by Cloudinary (e.g., `abc123xyz`)
- Full URL: `https://res.cloudinary.com/pawplanet/image/upload/v1/pawplanet/pets/789/gallery/abc123xyz.jpg`
- Authorization: Only if current user owns pet 789

### Example 3: Upload Encyclopedia Breed Image

**Request:**
```json
POST /api/v1/media/sign
{
  "context": "ENCYCLOPEDIA_BREED",
  "slug": "golden-retriever"
}
```

**Response:**
```json
{
  "signature": "def456...",
  "timestamp": 1704196800,
  "api_key": "123456789012345",
  "cloud_name": "pawplanet",
  "asset_folder": "pawplanet/encyclopedia/breeds/golden-retriever",
  "public_id": "golden-retriever",
  "resource_type": "image"
}
```

**Result:**
- Folder: `pawplanet/encyclopedia/breeds/golden-retriever/`
- Public ID: `golden-retriever`
- Full URL: `https://res.cloudinary.com/pawplanet/image/upload/v1/pawplanet/encyclopedia/breeds/golden-retriever/golden-retriever.jpg`

### Example 4: Upload Video to Post

**Request:**
```json
POST /api/v1/media/sign
{
  "context": "POST_MEDIA",
  "ownerId": 456,
  "resourceType": "video"
}
```

**Response:**
```json
{
  "signature": "ghi789...",
  "timestamp": 1704196800,
  "api_key": "123456789012345",
  "cloud_name": "pawplanet",
  "asset_folder": "pawplanet/posts/456",
  "public_id": null,
  "resource_type": "video"
}
```

## ‚ùå Error Responses

### Missing Required Field

**Request:**
```json
{
  "context": "USER_AVATAR"
  // Missing ownerId
}
```

**Response:** `400 Bad Request`
```json
{
  "code": 400,
  "message": "Owner ID is required for this upload context"
}
```

### Invalid Slug Format

**Request:**
```json
{
  "context": "ENCYCLOPEDIA_BREED",
  "slug": "Golden Retriever"  // Spaces not allowed
}
```

**Response:** `400 Bad Request`
```json
{
  "code": 400,
  "message": "Slug must be lowercase kebab-case (e.g., 'golden-retriever')"
}
```

### Invalid Context

**Request:**
```json
{
  "context": "INVALID_CONTEXT"
}
```

**Response:** `400 Bad Request`
```json
{
  "code": 400,
  "message": "Invalid upload context"
}
```

## üåê Frontend Integration

### Step 1: Request Signature from Backend

```javascript
const response = await fetch('/api/v1/media/sign', {
  method: 'POST',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    context: 'USER_AVATAR',
    ownerId: 42
  })
});

const signData = await response.json();
```

### Step 2: Upload to Cloudinary

```javascript
const formData = new FormData();
formData.append('file', fileInput.files[0]);
formData.append('api_key', signData.api_key);
formData.append('timestamp', signData.timestamp);
formData.append('signature', signData.signature);
formData.append('asset_folder', signData.asset_folder);
formData.append('resource_type', signData.resource_type);

if (signData.public_id) {
  formData.append('public_id', signData.public_id);
}

const uploadResponse = await fetch(
  `https://api.cloudinary.com/v1_1/${signData.cloud_name}/${signData.resource_type}/upload`,
  {
    method: 'POST',
    body: formData
  }
);

const uploadResult = await uploadResponse.json();
console.log('Uploaded URL:', uploadResult.secure_url);
```

### Step 3: Save URL to Your Backend

```javascript
// After successful upload, save the URL to your database
await fetch('/api/v1/users/me/avatar', {
  method: 'PUT',
  headers: {
    'Content-Type': 'application/json',
    'Authorization': 'Bearer YOUR_JWT_TOKEN'
  },
  body: JSON.stringify({
    avatarUrl: uploadResult.secure_url
  })
});
```

## üîí Security Features

1. **Signed Uploads**: All uploads require a valid signature that can only be generated server-side
2. **Folder Enforcement**: Frontend cannot choose arbitrary folders
3. **Context Validation**: Strict validation ensures proper data ownership
4. **API Secret Protection**: Secret never exposed to frontend
5. **Time-Limited**: Signatures expire after a reasonable time (Cloudinary default)

## üìù Validation Rules

### OwnerId Validation
- Must be provided for: `USER_AVATAR`, `PET_AVATAR`, `PET_GALLERY`, `POST_MEDIA`
- Must be a positive integer (> 0)
- Backend should verify ownership (implement authorization separately)

### Slug Validation
- Must be provided for: `ENCYCLOPEDIA_CLASS`, `ENCYCLOPEDIA_SPECIES`, `ENCYCLOPEDIA_BREED`
- Must match pattern: `^[a-z0-9]+(-[a-z0-9]+)*$`
- Examples: ‚úÖ `golden-retriever`, `labrador`, `german-shepherd-dog`
- Invalid: ‚ùå `Golden Retriever`, `golden_retriever`, `golden--retriever`, `-golden`, `retriever-`
- Automatically normalized to lowercase

### Resource Type
- Optional (defaults to "image")
- Valid values: `image`, `video`, `raw`, `auto`

## üéØ Best Practices

1. **Always validate ownership**: Before generating signatures for user/pet/post content, verify the requesting user owns that resource
2. **Use appropriate contexts**: Choose the correct context for your use case
3. **Handle errors gracefully**: Show user-friendly messages for validation errors
4. **Store only URLs**: After upload, only save the Cloudinary URL to your database
5. **Don't store files twice**: Upload directly to Cloudinary, don't upload to your backend first
6. **Use transformations**: Leverage Cloudinary's on-the-fly transformations in delivery URLs

## üîÑ Migration from Legacy Endpoint

The old endpoint `/api/v1/media/upload-signature` is deprecated. Migrate to the new endpoint:

**Old (Deprecated):**
```
GET /api/v1/media/upload-signature
```

**New (Recommended):**
```
POST /api/v1/media/sign
```

## üìö Additional Resources

- [Cloudinary Upload API](https://cloudinary.com/documentation/upload_images)
- [Signed Upload Tutorial](https://cloudinary.com/documentation/upload_images#signed_upload)
- [Asset Folders](https://cloudinary.com/documentation/dam_admin_asset_management#asset_folders)

---

**Version:** 1.0.0  
**Last Updated:** January 2, 2026

